<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¶ˆëŸ‰ ì‚¬ê³¼(ê°ì²´) ê°ì§€ ì‹œìŠ¤í…œ</title>
    </head>
    <body>
        <div>ë¶ˆëŸ‰ ì‚¬ê³¼(ê°ì²´) ê°ì§€ ì‹œìŠ¤í…œ_ì²´ë¦¬í”¼ì»¤</div>
        <!-- ë²„íŠ¼ -->
        <button type="button" onclick="init()">Start</button>
        <!-- ì»¨í…Œì´ë„ˆ -->
        <div id="webcam-container"></div>
        <div id="label-container"></div>
        <div id="label-container2"></div>
        
        <!-- CDN -->
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
        <script type="text/javascript">
        
        //í˜„ì¬ ì‹œê°„ ì°ê¸°(add)
        function timestamp() {
            var today = new Date();
            today.setHours(today.getHours() + 9);
            return today.toISOString().replace("T", " ").substring(0, 19);
        }
        
        function getToday() {
            var date = new Date();
            var year = date.getFullYear();
            var month = ("0" + (1 + date.getMonth())).slice(-2);
            var day = ("0" + date.getDate()).slice(-2);
            return year + "-" + month + "-" + day;
        }
        
        //WebSocket ì„¤ì •
        const webSocketUrl = "ws://192.168.139.1:8001";
        
        let ws = new WebSocket(webSocketUrl);
        // json.parse() ìœ„í•¨
        var data = {};
        var sendData = [];
        var jsonData;

        ws.onopen = function (e) {

        };
        


        // í•™ìŠµì‹œí‚¨ ëª¨ë¸ íŒŒì¼ ê²½ë¡œ
        const URL = "./my_model/";
        // ë³€ìˆ˜ ìƒì„±
        let model, webcam, labelContainer, maxPredictions;


        // ì´ë¯¸ì§€ ëª¨ë¸ì„ ë¡œë“œ(ë¶ˆëŸ¬ì˜¤ê¸°,ì ì¬) í•˜ê³ , ì›¹ ìº  ì„¤ì •â–¶â–¶â–¶
        async function init() {
            
            //ì‹¤í–‰ ë²„íŠ¼ í´ë¦­ì‹œ WenSocket ë°ì´í„°
            data["req"] = "openDetection";
            data["objectDate"] = timestamp() + ".000";
            data["objectName"] = "ì‚¬ê³¼";
            sendData.push(data);
            jsonData = JSON.stringify(sendData);
            ws.send(jsonData);
            sendData = [];


            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            
            // load the model and metadata
            // Refer to tmImage.loadFromFiles() in the API to support files from a file picker
            // or files from your local hard drive
            // Note: the pose library adds "tmImage" object to your window (window.tmImage)
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            // ì›¹ ìº  ì„¤ì •ì„ ìœ„í•œ í¸ì˜ ê¸°ëŠ¥(ì˜¤ì§ ì›¹ìº ë§Œ ì„¤ì •í•˜ëŠ” ì½”ë“œ)
            const flip = true; // ì›¹ìº ì„ ë’¤ì§‘ì„ì§€ ì—¬ë¶€: ê±°ìš¸ëª¨ë“œ ì„¤ì •/ì¢Œìš°ë°˜ì „ ì„¤ì •ì„ í•  ìˆ˜ ìˆë‹¤.
            webcam = new tmImage.Webcam(200, 200, flip); // width, height, flip
            await webcam.setup(); // ì›¹ìº  ì ‘ì†ì„ ìš”ì²­
            await webcam.play(); // ì›¹ìº  playí•˜ê¸°â–¶
            window.requestAnimationFrame(loop); //ê²Œì†í•´ì„œ frame ì†¡ì¶œì„ ìœ„í•œ ì½”ë“œ
            
            
            // ë¬¸ì„œ ê°ì²´ ëª¨ë¸ì— ìš”ì†Œ ì¶”ê°€
            document.getElementById("webcam-container").appendChild(webcam.canvas); //IDê°€ webcam-container ë¶€ë¶„ì— ì›¹ ìº  ê·¸ë¦¬ê¸°
            labelContainer = document.getElementById("label-container"); //ì›¹ ìº¡ ì¶œë ¥ ë¶€ë¶„ ë°‘ì— label(í…ìŠ¤íŠ¸ ë¶€ë¶„) : ë¶ˆëŸ‰ì‚¬ê³¼ ì…ë‹ˆë‹¤. or ì •ìƒì‚¬ê³¼ì…ë‹ˆë‹¤.
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
            labelContainer2 = document.getElementById("label-container2"); //ë§¨ ë°‘ label : ê°ì§€ëœ ë¶ˆëŸ‰ ì‚¬ê³¼ ìˆ˜: 
        }
        
        normalSec = 0;   // ì •ìƒ ë¬¼í’ˆ ì‹œê°„(ì´ˆ)
        normalCount = 0; // ì •ìƒ ë¬¼í’ˆ ê°œìˆ˜

        defectiveSec = 0;   // ë¶ˆëŸ‰ ë¬¼í’ˆ ì‹œê°„(ì´ˆ)
        defectiveCount = 0; // ë¶ˆëŸ‰ ë¬¼í’ˆ ê°œìˆ˜



        allSec = 0; // ëª¨ë“  ë¬¼í’ˆ ì´ˆ
        allCnt = 0; // ëª¨ë“  ë¬¼í’ˆ ê°œìˆ˜


        async function loop() {
            webcam.update(); // ì›¹ìº  í”„ë ˆì„ì„ ì—…ë°ì´íŠ¸
            await predict();
            // console.log(predict);
            window.requestAnimationFrame(loop); //ê²Œì†í•´ì„œ frame ì†¡ì¶œì„ ìœ„í•œ ì½”ë“œ
        }
        
        // run the webcam image through the image model
        async function predict() {
            // predict can take in an image, video or canvas html element
            const prediction = await model.predict(webcam.canvas);
            allSec++; //fps 
            if(allSec >=30){
                allSec = 0;
                allCnt = defectiveCount + normalCount;
                data["req"] = "defectiveAllobj";
                data["objectAllCnt"] = allCnt;
                sendData.push(data);
                jsonData = JSON.stringify(sendData);
                ws.send(jsonData);
                sendData = [];
            }
            

            //classNameì´ ì •ìƒì‚¬ê³¼(apple) ì¼ ê²½ìš°ğŸ
            if(prediction[0].className == "apple" && prediction[0].probability.toFixed(2) == 1.00){
                labelContainer.childNodes[0].innerHTML = "ì •ìƒ ì‚¬ê³¼ ì…ë‹ˆë‹¤."
                if(normalSec >= 30){
                    count++;
                    normalSec = 0;
                    labelContainer2.innerHTML = "ê°ì§€ëœ ì •ìƒ ì‚¬ê³¼ ìˆ˜:" +normalCount;
                }
            }
            // classNameì´ ì©ì€ì‚¬ê³¼(rotten_apple)ì¼ ê²½ìš°ğŸ
            else if(prediction[1].className == "rotten_apple" && prediction[1].probability.toFixed(2) == 1.00){
                defectiveSec++;
                normalSec = 0;
                labelContainer.childNodes[0].innerHTML = "ë¶ˆëŸ‰ ì‚¬ê³¼ ì…ë‹ˆë‹¤."
                if(defectiveSec >= 30){
                    defectiveCount++;
                    defectiveSec = 0;  
                    labelContainer2.innerHTML = "ê°ì§€ëœ ë¶ˆëŸ‰ ì‚¬ê³¼ ìˆ˜:"+defectiveCount;

                    var audio = new Audio('detect.mp3'); //ë¶ˆëŸ‰í’ˆì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.2ì´ˆì§œë¦¬ ìŒì„±íŒŒì¼
                    audio.play();
                    
                    data["req"] = "defectiveObj_LOG";
                    data["objectLog"] = timestamp() + ".000";
                    data["objectDefCnt"] = defectiveCount;
                    sendData.push(data);
                    jsonData = JSON.stringify(sendData);
                    ws.send(jsonData);
                    sendData = [];
                }
            }else{
                labelContainer.childNodes[0].innerHTML = "ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            }
        }
        </script>
    </body>
</html>